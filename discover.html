<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0b1020" />

  <title>DÃ©couvrir au hasard â€” Giveaway Linux</title>
  <meta name="description" content="DÃ©couvrez au hasard un logiciel ou un jeu gratuit pour Linux. SÃ©lection alÃ©atoire, liens officiels uniquement, sans tracking." />
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />

  <link rel="canonical" href="https://zlormann.github.io/Giveaway-Linux/discover.html" />

  <!-- Open Graph -->
  <meta property="og:site_name" content="Giveaway Linux" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="DÃ©couvrir au hasard â€” Giveaway Linux" />
  <meta property="og:description" content="Un logiciel ou un jeu Linux gratuit choisi au hasard. Liens officiels uniquement." />
  <meta property="og:url" content="https://zlormann.github.io/Giveaway-Linux/discover.html" />
  <meta property="og:image" content="https://zlormann.github.io/Giveaway-Linux/assets/logo.png" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="DÃ©couvrir au hasard â€” Giveaway Linux" />
  <meta name="twitter:description" content="Un logiciel ou un jeu Linux gratuit choisi au hasard." />
  <meta name="twitter:image" content="https://zlormann.github.io/Giveaway-Linux/assets/logo.png" />

  <!-- JSON-LD -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "name":"DÃ©couvrir au hasard",
    "url":"https://zlormann.github.io/Giveaway-Linux/discover.html",
    "description":"Page de dÃ©couverte alÃ©atoire (logiciels et jeux gratuits pour Linux).",
    "isPartOf":{"@type":"WebSite","name":"Giveaway Linux","url":"https://zlormann.github.io/Giveaway-Linux/"},
    "inLanguage":"fr"
  }
  </script>

  <link rel="stylesheet" href="./css/style.css" />
</head>

<body>
  <div class="wrap">
    <header class="topbar">
      <div class="brand">
        <img src="./assets/logo.svg" alt="Logo Giveaway Linux" width="34" height="34" />
        <div>
          <h1>DÃ©couvrir</h1>
          <p>ğŸ² AlÃ©atoire â€¢ ğŸ¯ ThÃ©matique â€¢ ğŸ“… Par date</p>
        </div>
      </div>

      <nav class="nav">
        <a class="tab" href="./index.html">ğŸ  Accueil</a>
        <a class="tab active" href="./discover.html" aria-current="page">ğŸ² DÃ©couvrir</a>
        <a class="tab" href="./archive.html">ğŸ—“ Archives</a>
        <a class="tab" href="./favorites.html">â­ Favoris</a>
        <a class="tab" href="./rss.xml">ğŸ“¡ RSS</a>
      </nav>
    </header>

    <section class="section">
      <div class="head">
        <h2>ğŸ DÃ©couverte</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <button id="reroll" class="btn">ğŸ”„ Relancer</button>
          <button id="clearSeen" class="btn">ğŸ§¹ Reset â€œdÃ©jÃ  vusâ€</button>
        </div>
      </div>

      <div class="body">
        <!-- ContrÃ´les -->
        <div class="card">
          <div class="inner">
            <div class="grid2" style="gap:12px;">
              <div>
                <div class="muted">Mode</div>
                <select id="mode" class="input">
                  <option value="random">ğŸ² AlÃ©atoire</option>
                  <option value="date">ğŸ“… Par date (catalog)</option>
                </select>
              </div>

              <div>
                <div class="muted">Type</div>
                <select id="type" class="input">
                  <option value="all">Tout (logiciel ou jeu)</option>
                  <option value="software">Logiciel</option>
                  <option value="game">Jeu</option>
                </select>
              </div>

              <div>
                <div class="muted">CatÃ©gorie / Genre (thÃ¨me)</div>
                <select id="tag" class="input">
                  <option value="">Tout</option>
                </select>
              </div>

              <div>
                <div class="muted">Date (YYYY-MM-DD)</div>
                <input id="date" class="input" placeholder="2026-02-07" />
              </div>
            </div>

            <div style="height:10px"></div>
            <div class="note" id="hint">
              Astuce : tu peux aussi utiliser lâ€™URL, ex :
              <br><span class="muted">discover.html?type=software&tag=Graphics</span>
              <br><span class="muted">discover.html?mode=date&date=2026-02-07</span>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div id="result" class="note">Chargementâ€¦</div>
      </div>
    </section>

    <footer class="footer">
      âœ“ Aucun tracking â€¢ Favoris locaux â€¢ Â© 2026 Giveaway Linux
    </footer>
  </div>

  <script>
    // ---------- Config ----------
    const BASE = new URL("./", location.href);
    const FAV_KEY  = "gl_favorites_v1";
    const SEEN_KEY = "gl_seen_v1"; // anti-doublon â€œdÃ©jÃ  vusâ€

    const $ = (s) => document.querySelector(s);

    const esc = s => String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;");

    function pickUrl(o){
      return o?.url || o?.home_url || o?.download_url || "#";
    }

    async function loadJSON(p){
      const r = await fetch(new URL(p, BASE), { cache:"no-store" });
      if(!r.ok) throw new Error("HTTP " + r.status + " sur " + p);
      return r.json();
    }

    function getFavs(){
      try { return JSON.parse(localStorage.getItem(FAV_KEY) || "[]"); }
      catch { return []; }
    }
    function toggleFav(id){
      const f = getFavs();
      const i = f.indexOf(id);
      if(i >= 0) f.splice(i,1); else f.unshift(id);
      localStorage.setItem(FAV_KEY, JSON.stringify(f.slice(0,200)));
    }

    function getSeen(){
      try { return JSON.parse(localStorage.getItem(SEEN_KEY) || "[]"); }
      catch { return []; }
    }
    function addSeen(id){
      const seen = getSeen();
      // garde max 800 pour rester lÃ©ger
      const next = [id, ...seen.filter(x => x !== id)].slice(0, 800);
      localStorage.setItem(SEEN_KEY, JSON.stringify(next));
    }
    function clearSeen(){
      localStorage.removeItem(SEEN_KEY);
    }

    function randomFrom(arr){
      return arr[Math.floor(Math.random() * arr.length)];
    }

    // Anti-doublon intelligent : essaye N fois avant dâ€™accepter un dÃ©jÃ -vu
    function smartPick(arr, idFn, maxTries = 25){
      const seen = new Set(getSeen());
      if(arr.length === 0) return null;

      for(let i=0;i<maxTries;i++){
        const it = randomFrom(arr);
        const id = idFn(it);
        if(!seen.has(id)) return it;
      }
      // si tout est â€œvuâ€ ou trop de rÃ©pÃ©titions -> on accepte un au hasard
      return randomFrom(arr);
    }

    function uniqSorted(arr){
      return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=> String(a).localeCompare(String(b)));
    }

    // Remplit la liste â€œtagâ€ depuis software.json + games.json
    function fillTags(soft, games){
      const tags = [];
      (soft || []).forEach(s => tags.push(s.category));
      (games || []).forEach(g => tags.push(g.genre));
      const list = uniqSorted(tags);

      const sel = $("#tag");
      sel.innerHTML = `<option value="">Tout</option>` + list.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join("");
    }

    // Lit les paramÃ¨tres URL et les applique
    function applyQueryToUI(){
      const q = new URLSearchParams(location.search);

      const mode = q.get("mode");
      const type = q.get("type");
      const tag  = q.get("tag");
      const date = q.get("date");

      if(mode && ["random","date"].includes(mode)) $("#mode").value = mode;
      if(type && ["all","software","game"].includes(type)) $("#type").value = type;
      if(tag !== null) $("#tag").value = tag;
      if(date) $("#date").value = date;
    }

    // Met Ã  jour lâ€™URL (SEO/partage) sans recharger
    function syncURL(){
      const q = new URLSearchParams();
      const mode = $("#mode").value;
      const type = $("#type").value;
      const tag  = $("#tag").value.trim();
      const date = $("#date").value.trim();

      if(mode !== "random") q.set("mode", mode);
      if(type !== "all") q.set("type", type);
      if(tag) q.set("tag", tag);
      if(mode === "date" && date) q.set("date", date);

      const newUrl = location.pathname + (q.toString() ? ("?" + q.toString()) : "");
      history.replaceState(null, "", newUrl);
    }

    function renderSingleCard(item, kind){
      const typeLabel = kind === "software" ? "ğŸ§© Logiciel" : "ğŸ® Jeu";
      const meta = item.category || item.genre || "â€”";
      const url  = pickUrl(item);
      const id   = item.id || (kind + ":" + item.name);
      const fav  = getFavs().includes(id);

      return `
        <div class="card">
          <div class="inner">
            <div class="muted">${typeLabel}</div>
            <h3>${esc(item.name)}</h3>
            <div class="tags"><span class="tag">${esc(meta)}</span></div>

            <div class="links" style="margin-top:12px">
              <a class="btn primary" href="${esc(url)}" target="_blank" rel="noopener">â¬‡ TÃ©lÃ©charger</a>
              <button class="btn" data-fav="${esc(id)}">${fav ? "â­ Retirer" : "â˜† Favori"}</button>
            </div>
          </div>
        </div>
      `;
    }

    function bindFavButtons(){
      document.querySelectorAll("[data-fav]").forEach(btn => {
        btn.addEventListener("click", () => {
          toggleFav(btn.getAttribute("data-fav"));
          draw(); // refresh UI
        });
      });
    }

    // Mode date: charge data/catalog.json (si existe)
    async function drawByDate(soft, games){
      const box = $("#result");
      const date = $("#date").value.trim();

      box.className = "note";
      box.textContent = "Chargement du catalogueâ€¦";

      try{
        const catalog = await loadJSON("data/catalog.json"); // liste d'entrÃ©es jour
        if(!Array.isArray(catalog) || catalog.length === 0){
          box.className = "note";
          box.textContent = "catalog.json est vide. Ajoute lâ€™historique (30 jours) pour activer le mode date.";
          return;
        }
        if(!date){
          box.className = "note";
          box.textContent = "Entre une date (ex: 2026-02-07) ou mets ?mode=date&date=YYYY-MM-DD";
          return;
        }

        const entry = catalog.find(e => e && e.date === date);
        if(!entry){
          box.className = "note";
          box.textContent = "Aucune entrÃ©e trouvÃ©e pour cette date dans catalog.json.";
          return;
        }

        const app = (soft || []).find(s => s.id === entry.software_id) || null;
        const game = (games || []).find(g => g.id === entry.game_id) || null;

        box.className = "";
        box.innerHTML = `
          <div class="success">ğŸ“… SÃ©lection du <b>${esc(date)}</b> (depuis <code>data/catalog.json</code>)</div>
          <div style="height:12px"></div>
          <div class="grid2">
            ${app ? renderSingleCard(app, "software") : `<div class="danger">Logiciel introuvable (ID: ${esc(entry.software_id)})</div>`}
            ${game ? renderSingleCard(game, "game") : `<div class="danger">Jeu introuvable (ID: ${esc(entry.game_id)})</div>`}
          </div>
        `;

        // on marque comme â€œvuâ€
        if(app) addSeen("software:" + (app.id || app.name));
        if(game) addSeen("game:" + (game.id || game.name));

        bindFavButtons();
      }catch(err){
        box.className = "danger";
        box.textContent = "Impossible de charger data/catalog.json (mode date).";
      }
    }

    async function drawRandom(soft, games){
      const box = $("#result");
      const type = $("#type").value; // all / software / game
      const tag  = $("#tag").value.trim(); // category/genre

      let pool = [];
      let kind = "software";

      if(type === "software"){
        pool = (soft || []).filter(s => !tag || String(s.category||"") === tag);
        kind = "software";
      } else if(type === "game"){
        pool = (games || []).filter(g => !tag || String(g.genre||"") === tag);
        kind = "game";
      } else {
        // all
        const softPool = (soft || []).filter(s => !tag || String(s.category||"") === tag).map(x => ({...x, __kind:"software"}));
        const gamePool = (games || []).filter(g => !tag || String(g.genre||"") === tag).map(x => ({...x, __kind:"game"}));
        pool = [...softPool, ...gamePool];
      }

      if(pool.length === 0){
        box.className = "note";
        box.textContent = "Aucun rÃ©sultat avec ce filtre. Mets 'Tout' ou enlÃ¨ve le thÃ¨me.";
        return;
      }

      // smart pick anti-doublon
      const it = smartPick(pool, (x) => {
        const k = x.__kind || (x.genre ? "game" : "software");
        return k + ":" + (x.id || x.name);
      });

      const realKind = it.__kind || (it.genre ? "game" : "software");
      const id = realKind + ":" + (it.id || it.name);

      box.className = "";
      box.innerHTML = `
        <div class="success">ğŸ² Tirage alÃ©atoire ${tag ? `â€” ThÃ¨me : <b>${esc(tag)}</b>` : ""}</div>
        <div style="height:12px"></div>
        ${renderSingleCard(it, realKind)}
      `;

      addSeen(id);
      bindFavButtons();
    }

    async function draw(){
      const box = $("#result");
      box.className = "note";
      box.textContent = "Chargementâ€¦";

      syncURL();

      try{
        const [soft, games] = await Promise.all([
          loadJSON("data/software.json"),
          loadJSON("data/games.json")
        ]);

        // tags
        fillTags(soft, games);

        // re-applique tag si venu de lâ€™URL et pas encore prÃ©sent
        applyQueryToUI();
        syncURL();

        const mode = $("#mode").value; // random / date
        if(mode === "date"){
          await drawByDate(soft, games);
        } else {
          await drawRandom(soft, games);
        }
      }catch(err){
        box.className = "danger";
        box.textContent = "Erreur : impossible de charger data/software.json ou data/games.json.";
      }
    }

    // Events UI
    $("#reroll").addEventListener("click", draw);
    $("#clearSeen").addEventListener("click", () => { clearSeen(); draw(); });

    ["mode","type","tag","date"].forEach(id => {
      $("#" + id).addEventListener("change", draw);
      $("#" + id).addEventListener("input", () => {
        if(id === "date") syncURL();
      });
    });

    // Boot
    (function init(){
      applyQueryToUI();
      draw();
    })();
  </script>
</body>
</html>
